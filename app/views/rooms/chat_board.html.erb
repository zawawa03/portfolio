<% breadcrumb :room_chat_board, @room %>
<div class="container" id="chat-board">
  <div class="row">
    <div class="col-md-3" id="join-user">
      <div class="d-flex flex-column">
        <div class="mt-5 py-3 ps-2" id="user-list">
          <h5><%= t(".joiner") %></h5>
          <% @users.each do |user| %>
            <div class="dropdown">
              <div class="d-flex dropdown-toggle" data-bs-toggle="<%= 'dropdown' unless user == current_user %>" role="button" aria-expanded="false">
                <%= image_tag user.profile.decorate.avatar_image(40,40), class: "rounded-circle", id: "room-avatar" %>
                <span class="align-self-center ms-1" id="<%= 'user-dropdown' unless user == current_user %>"><%= user.profile.nickname %></span>
                <% if current_user. blocked_user?(user) %>
                  <i class="bi bi-exclamation-circle" style="font-size: 1rem; color: red;"></i> 
                <% end %>
              </div>      
              <ul class="dropdown-menu">
                <li><%= link_to t(".profile"), user_profile_path(user), class: "dropdown-item" %></li>
                <li><%= link_to t(".friend"), new_friend_path(user), data: { turbo_method: :post },class: "dropdown-item" %></li>
                <li><%= link_to t("sidebar.block_friend"), block_friend_path(user), class: "dropdown-item link-danger", data: { turbo_method: :patch, turbo_confirm: t("sidebar.confirm_block") } %></li>
              </ul>
            </div> 
          <% end %>
        </div>  
        <div class="mt-5 py-3 ps-2" id="permit-user" data-id="<%= current_user.id %>">
          <h5><%= t(".permiter") %></h5>
            <div id="permit_user_field">
              <% @permits.each do |permit| %>
                <div class="d-flex" id="permit_<%= permit.id %>">
                  <div class="dropdown">
                    <div class="d-flex dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false">
                      <%= image_tag permit.user.profile.decorate.avatar_image(40,40), class: "rounded-circle", id: "room-avatar" %>
                      <span class="align-self-center ms-1" id="user-dropdown"><%= permit.user.profile.nickname %></span>
                      <% if current_user.blocked_user?(permit.user) %>
                        <i class="bi bi-exclamation-circle" style="font-size: 1rem; color: red;"></i>
                      <% end %> 
                    </div>
                    <ul class="dropdown-menu">
                      <li><%= link_to t(".profile"), user_profile_path(permit.user), class: "dropdown-item" %></li>
                      <li><%= link_to t(".friend"), new_friend_path(permit.user), data: { turbo_method: :post }, class: "dropdown-item" %></li>
                      <li><%= link_to t("sidebar.block_friend"), block_friend_path(permit.user), class: "dropdown-item link-danger", data: { turbo_method: :patch, turbo_confirm: t("sidebar.confirm_block") } %></li>
                    </ul>
                  </div>    
                  <% if @room.creator == current_user %>
                    <div class="ms-auto me-1">
                      <%= link_to t(".approve"), approve_room_permit_path(@room, permit), data: { turbo_method: :post }, class: "btn btn-primary btn-sm" %>
                      <%= link_to t(".refuse"), refuse_room_permit_path(@room, permit), data: { turbo_method: :delete }, class: "btn btn-danger btn-sm" %>
                    </div>  
                  <% end %>
                </div>   
              <% end %>
            </div>   
        </div>
      </div>
    </div>
    <div class="col-md-5">
      <div class="d-flex flex-column mt-5 p-3 overflow-auto" id="message-field" data-id="<%= @room.id %>">
        <% @messages.each do |message| %>
          <div class="d-flex flex-column <%= message.user == current_user ? 'align-self-end' : 'align-self-start' %>">
            <div class="d-flex justify-content-<%= message.user == current_user ? 'end' : 'start' %>">
              <%= image_tag message.user.profile.decorate.avatar_image(40, 40), class: "rounded-circle", id: "message-avatar" %>
              <span><%= message.message_nickname %></span>
            </div>  
            <p class="align-self-<%= message.user == current_user ? 'end' : 'start' %>"><%= message.body %></p>
          </div>
        <% end %>
      </div>
      <form class="mt-3">
        <input type="text" placeholder="メッセージを送信" class="form-control" name="message" id="message-form">
      </form>
    </div>
    <div class="col-md-2 mt-5">
      <div class="d-flex flex-column" id="detail-field">
        <div class="twitter d-flex justify-content-center">
          <%= link_to "https://twitter.com/share?url=#{room_url(@room)}&text=【gamers room】%0a パーティーに参加して一緒にプレイしよう！ %0a#{@room.title}&hashtags=#{@room.game.name},ゲーム募集", target: '_blank', data: { toggle: "tooltip", placement: "bottom" }, title: "Xでシェア" do %>
            <i class="bi bi-twitter-x"></i>
          <% end %>  
        </div>
        <div class="d-flex justify-content-center">
          <%= link_to t(".leave"), leave_room_path(@room), data: { turbo_method: :delete, turbo_confirm: t(".leave_confirm") },class: "btn btn-danger" %>
        </div>
      </div>   
    </div>
  </div>
</div>