<% breadcrumb :room_chat_board, @room %>
<div class="container" id="chat-board">
  <div class="row">
    <div class="col-md-3" id="join-user">
      <div class="d-flex flex-column">
        <div class="mt-5 py-3 ps-2" id="user-list">
          <h5><%= t(".joiner") %></h5>
          <% @users.each do |user| %>
            <div class="d-flex">
              <div class="dropdown">
                <div class="d-flex dropdown-toggle" data-bs-toggle="<%= 'dropdown' unless user == current_user %>" role="button" aria-expanded="false">
                  <%= image_tag user.profile.decorate.avatar_image(40,40), class: "rounded-circle", id: "room-avatar" %>
                  <span class="align-self-center ms-1" id="<%= 'user-dropdown' unless user == current_user %>"><%= user.profile.nickname %></span>
                  <% if current_user. blocked_user?(user) %>
                    <i class="bi bi-exclamation-circle" style="font-size: 1rem; color: red;"></i> 
                  <% end %>
                </div>      
                <ul class="dropdown-menu" id="drop_down">
                  <li><%= link_to user_profile_path(user), class: "dropdown-item" do %><i class="bi bi-person-circle me-1"></i><%= t(".profile") %><% end %></li>
                  <li><%= link_to new_friend_path(user), data: { turbo_method: :post },class: "dropdown-item" do %><i class="bi bi-chat-dots me-1"></i><%= t(".friend") %><% end %></li>
                  <li><%= link_to block_friend_path(user), class: "dropdown-item link-danger", data: { turbo_method: :patch, turbo_confirm: t("sidebar.confirm_block") } do %><i class="bi bi-ban me-1"></i><%= t("sidebar.block_friend") %><% end %></li>
                </ul>
              </div>
              <% if @room.creator == current_user && user != @room.creator %>
                <div class="ms-auto me-1">
                  <%= link_to t(".kick"), kick_user_room_path(@room, user), data: { turbo_method: :patch, turbo_confirm: t(".kick_confirm") }, class: "btn btn-sm", id: "permit_danger_btn" %>  
                </div>
              <% end %>
            </div>    
          <% end %>
        </div>  
        <div class="mt-5 py-3 ps-2" id="permit-user" data-id="<%= current_user.id %>">
            <p>
              <i class="bi bi-exclamation-circle" style="font-size: 1rem; color: red;"></i>
              はブロックしているユーザーです
            </p>
            <h5><%= t(".permiter") %></h5> 
            <div id="permit_user_field">
              <% @permits.each do |permit| %>
                <div class="d-flex" id="permit_<%= permit.id %>">
                  <div class="dropdown">
                    <div class="d-flex dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false">
                      <%= image_tag permit.user.profile.decorate.avatar_image(40,40), class: "rounded-circle", id: "room-avatar" %>
                      <span class="align-self-center ms-1" id="user-dropdown"><%= permit.user.profile.nickname %></span>
                      <% if current_user.blocked_user?(permit.user) %>
                        <i class="bi bi-exclamation-circle" style="font-size: 1rem; color: red;"></i>
                      <% end %> 
                    </div>
                    <ul class="dropdown-menu" id="drop_down">
                      <li><%= link_to user_profile_path(permit.user), class: "dropdown-item" do %><i class="bi bi-person-circle me-1"></i><%= t(".profile") %><% end %></li>
                      <li><%= link_to new_friend_path(permit.user), data: { turbo_method: :post }, class: "dropdown-item" do %><i class="bi bi-chat-dots me-1"></i><%= t(".friend") %><% end %></li>
                      <li><%= link_to block_friend_path(permit.user), class: "dropdown-item link-danger", data: { turbo_method: :patch, turbo_confirm: t("sidebar.confirm_block") } do %><i class="bi bi-ban me-1"></i><%= t("sidebar.block_friend") %><% end %></li>
                    </ul>
                  </div>    
                  <% if @room.creator == current_user %>
                    <div class="ms-auto me-1">
                      <%= link_to t(".approve"), approve_room_permit_path(@room, permit), data: { turbo_method: :post }, class: "btn btn-sm", id: "permit_primary_btn" %>
                      <%= link_to t(".refuse"), refuse_room_permit_path(@room, permit), data: { turbo_method: :delete }, class: "btn btn-sm", id: "permit_danger_btn" %>
                    </div>  
                  <% end %>
                </div>   
              <% end %>
            </div>    
        </div>
      </div>
    </div>
    <div class="col-md-5">
      <div class="d-flex flex-column mt-5 p-3 overflow-auto" id="message-field" data-id="<%= @room.id %>">
        <% @messages.each do |message| %>
          <div class="d-flex flex-column <%= message.user == current_user ? 'align-self-end' : 'align-self-start' %>">
            <div class="d-flex justify-content-<%= message.user == current_user ? 'end' : 'start' %>">
              <%= image_tag message.user.profile.decorate.avatar_image(40, 40), class: "rounded-circle", id: "message-avatar" %>
              <span><%= message.message_nickname %></span>
            </div>  
            <p class="align-self-<%= message.user == current_user ? 'end' : 'start' %>"><%= message.body %></p>
          </div>
        <% end %>
      </div>
      <form class="mt-3">
        <input type="text" placeholder=<%= t("default.form_placeholder") %> class="form-control" name="message" id="message-form">
      </form>
    </div>
    <div class="col-md-3 mt-5">
      <div class="d-flex flex-column rounded" id="detail-field">
        <div class="mt-3 d-flex justify-content-center"> 
          <div>
            <h5><%= @room.title %></h5>
            <h6><%= @room.game.name %></h6>
            <div class="d-flex flex-wrap mb-2" id="tag-area">
              <% @room.tags.each do |tag| %>
              <span class="mb-1"><%= tag.name %></span>
              <% end %>
            </div>
            <div class="d-flex">
              <div><span><%= t(".people") %><span></div>
              <span class="ms-2"><%= @room.users.count %>/<%= @room.people %></span>
            </div>
          </div>
        </div>    
        <div class="p-2"><%= simple_format(@room.body) %></div>
        <div class="d-flex justify-content-center">
          <% if @room.creator == current_user %>
            <div class="d-flex justify-content-center me-2" id="edit_btn_area">
              <%= link_to edit_room_path(@room), class: "btn", id: "edit_btn" do %><i class="bi bi-pencil-square me-2"></i><%= t("default.edit") %><% end %>
            </div>
          <% end %>
          <div class="d-flex justify-content-center me-2" id="delete_btn_area">
            <%= link_to leave_room_path(@room), class: "btn", data: { turbo_method: :delete, turbo_confirm: t(".leave_confirm") },id: "delete_btn" do %><i class="bi bi-door-open me-1"></i><%= t(".leave") %><% end %>
          </div>
        </div>
        <div class="d-flex justify-content-center mt-2">
          <div class="d-flex justify-content-center" id="discord_btn_area">
            <a href="https://discord.gg/ZxFyMFjDNq" target="_blank" class="btn" id="discord_btn"><i class="bi bi-discord me-1"></i><%= t("default.discord_btn") %></a>
          </div>
        </div>  
      </div> 
      <div class="twitter d-flex justify-content-center mt-3">
        <%= link_to "https://twitter.com/share?url=#{room_url(@room)}&text=【gamers room】%0a パーティーに参加して一緒にプレイしよう！ %0a#{@room.title}&hashtags=#{@room.game.name},ゲーム募集", target: '_blank', data: { toggle: "tooltip", placement: "bottom" }, title: "Xでシェア" do %>
          <i class="bi bi-twitter-x" id="twitter"></i>
        <% end %>
      <div> 
    </div>
  </div>
</div>